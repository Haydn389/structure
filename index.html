<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>철근 콘크리트 기둥 PM 상관도 분석기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 스크롤바 스타일링 (다크모드) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .input-group input {
            flex-grow: 1;
        }
        .input-group span {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">철근 콘크리트 기둥 PM 상관도 분석기</h1>
            <p class="text-gray-400 mt-2">KCI 기준에 따른 공칭강도 및 설계강도 곡선을 생성합니다.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 입력 폼 및 단면 시각화 -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 border-b-2 border-indigo-500 pb-2">입력 변수</h2>
                
                <form id="pm-form" class="space-y-4">
                    <!-- 재료 강도 -->
                    <div>
                        <h3 class="text-lg font-medium text-indigo-400 mb-2">재료 강도</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="fck" class="block text-sm font-medium text-gray-300 mb-1">fck (MPa)</label>
                                <input type="number" id="fck" value="24" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="fy" class="block text-sm font-medium text-gray-300 mb-1">fy (MPa)</label>
                                <input type="number" id="fy" value="400" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>

                    <!-- 단면 정보 -->
                    <div>
                        <h3 class="text-lg font-medium text-indigo-400 mt-4 mb-2">단면 정보</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="b" class="block text-sm font-medium text-gray-300 mb-1">폭 b (mm)</label>
                                <input type="number" id="b" value="400" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="h" class="block text-sm font-medium text-gray-300 mb-1">깊이 h (mm)</label>
                                <input type="number" id="h" value="600" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="d_prime" class="block text-sm font-medium text-gray-300 mb-1">d' (mm)</label>
                                <input type="number" id="d_prime" value="60" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>

                    <!-- 철근 정보 -->
                    <div>
                        <h3 class="text-lg font-medium text-indigo-400 mt-4 mb-2">철근 정보</h3>
                        <!-- 압축측 철근 -->
                        <div class="bg-gray-700 p-3 rounded-lg mb-3">
                            <label class="block text-sm font-medium text-gray-300 mb-2">압축측 철근 (A's)</label>
                            <div class="input-group">
                                <input type="number" id="as_prime_num" value="3" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="개수">
                                <span>- D</span>
                                <input type="number" id="as_prime_dia" value="22" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="직경">
                            </div>
                        </div>
                        <!-- 인장측 철근 -->
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <label class="block text-sm font-medium text-gray-300 mb-2">인장측 철근 (As)</label>
                            <div class="input-group">
                                <input type="number" id="as_num" value="3" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="개수">
                                <span>- D</span>
                                <input type="number" id="as_dia" value="22" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="직경">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" id="draw-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-colors duration-300 mt-6">
                        PM 상관도 그리기
                    </button>
                </form>

                <div id="error-message" class="mt-4 text-red-400 font-medium"></div>

                <!-- 단면 시각화 -->
                <div class="mt-8">
                    <h3 class="text-lg font-medium text-indigo-400 mb-2">단면 시각화</h3>
                    <div class="bg-gray-700 p-4 rounded-lg aspect-w-1 aspect-h-1">
                         <canvas id="section-canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- PM 상관도 그래프 -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">P-M 상관도</h2>
                    <div class="flex space-x-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-cyan-400 rounded-full mr-2"></div>
                            <span>공칭 강도 (Pn, Mn)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                            <span>설계 강도 (&phi;Pn, &phi;Mn)</span>
                        </div>
                    </div>
                </div>
                <div class="w-full h-[600px] bg-gray-900 rounded-lg p-2">
                    <canvas id="pm-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM 요소 가져오기
        const form = document.getElementById('pm-form');
        const drawBtn = document.getElementById('draw-btn');
        const errorMessage = document.getElementById('error-message');
        const pmCanvas = document.getElementById('pm-canvas');
        const sectionCanvas = document.getElementById('section-canvas');
        const pmCtx = pmCanvas.getContext('2d');
        const sectionCtx = sectionCanvas.getContext('2d');

        // 상수 정의
        const Es = 200000; // 철근의 탄성계수 (MPa)
        const epsilon_cu = 0.003; // 콘크리트의 극한 변형률

        // --- 단면 시각화 로직 ---
        function drawSection() {
            const inputs = getInputs();
            if (!inputs) return;

            const { b, h, d_prime, as_prime_num, as_prime_dia, as_num, as_dia } = inputs;
            const d = h - d_prime; // 유효깊이 d는 h와 d'로부터 계산

            const canvas = sectionCanvas;
            const ctx = sectionCtx;
            const parent = canvas.parentElement;
            
            // 캔버스 크기를 부모 요소에 맞춤 (반응형)
            const size = parent.clientWidth;
            canvas.width = size;
            canvas.height = size;

            ctx.clearRect(0, 0, size, size);
            
            // 그리기 영역 설정
            const padding = 30;
            const drawWidth = size - 2 * padding;
            const drawHeight = size - 2 * padding;
            
            const scale = Math.min(drawWidth / b, drawHeight / h);
            
            const rectWidth = b * scale;
            const rectHeight = h * scale;
            const xOffset = (size - rectWidth) / 2;
            const yOffset = (size - rectHeight) / 2;

            // 기둥 단면 그리기
            ctx.strokeStyle = '#9ca3af'; // gray-400
            ctx.lineWidth = 2;
            ctx.strokeRect(xOffset, yOffset, rectWidth, rectHeight);

            // 철근 그리기
            const drawRebar = (num, dia, depth, color) => {
                if (num > 0 && dia > 0) {
                    const rebarRadius = (dia / 2) * scale;
                    const yPos = yOffset + depth * scale;
                    
                    if (num === 1) {
                        ctx.beginPath();
                        ctx.arc(size / 2, yPos, rebarRadius, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.fill();
                    } else {
                        const spacing = rectWidth / num;
                        for (let i = 0; i < num; i++) {
                            const xPos = xOffset + spacing / 2 + i * spacing;
                            ctx.beginPath();
                            ctx.arc(xPos, yPos, rebarRadius, 0, 2 * Math.PI);
                            ctx.fillStyle = color;
                            ctx.fill();
                        }
                    }
                }
            };
            
            // 압축 철근
            drawRebar(as_prime_num, as_prime_dia, d_prime, '#f87171'); // red-400
            // 인장 철근
            drawRebar(as_num, as_dia, d, '#60a5fa'); // blue-400

            // 치수선 그리기
            ctx.fillStyle = '#d1d5db'; // gray-300
            ctx.font = '12px Noto Sans KR';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 폭(b) 치수
            ctx.fillText(`b = ${b} mm`, size / 2, yOffset - 15);
            // 깊이(h) 치수
            ctx.save();
            ctx.translate(xOffset - 15, size / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(`h = ${h} mm`, 0, 0);
            ctx.restore();
        }

        // --- 입력값 처리 및 유효성 검사 ---
        function getInputs() {
            const inputs = {
                fck: parseFloat(document.getElementById('fck').value),
                fy: parseFloat(document.getElementById('fy').value),
                b: parseFloat(document.getElementById('b').value),
                h: parseFloat(document.getElementById('h').value),
                d_prime: parseFloat(document.getElementById('d_prime').value),
                as_prime_num: parseInt(document.getElementById('as_prime_num').value),
                as_prime_dia: parseFloat(document.getElementById('as_prime_dia').value),
                as_num: parseInt(document.getElementById('as_num').value),
                as_dia: parseFloat(document.getElementById('as_dia').value),
            };

            // 유효성 검사
            for (const key in inputs) {
                if (isNaN(inputs[key]) || inputs[key] <= 0) {
                    errorMessage.textContent = `오류: '${key}'에 유효한 양수 값을 입력하세요.`;
                    return null;
                }
            }
            
            // d'과 d의 관계 확인
            if (inputs.d_prime >= inputs.h / 2) {
                errorMessage.textContent = "오류: d'은 h/2보다 작아야 합니다.";
                return null;
            }

            errorMessage.textContent = ''; // 오류 메시지 초기화
            return inputs;
        }

        // 철근 단면적 계산
        function calculateSteelArea(num, dia) {
            if (num > 0 && dia > 0) {
                return num * (Math.PI * Math.pow(dia / 2, 2));
            }
            return 0;
        }

        // --- PM 상관도 계산 로직 ---
        function calculatePMPoints() {
            const params = getInputs();
            if (!params) return null;

            const { fck, fy, b, h, d_prime } = params;
            const d = h - d_prime;
            const As_prime = calculateSteelArea(params.as_prime_num, params.as_prime_dia);
            const As = calculateSteelArea(params.as_num, params.as_dia);

            // beta1 계산 (KCI 2021 기준)
            let beta1;
            if (fck <= 28) {
                beta1 = 0.85;
            } else if (fck > 56) {
                beta1 = 0.65;
            } else {
                beta1 = 0.85 - 0.05 * (fck - 28) / 7;
            }
            
            const epsilon_y = fy / Es;
            const points = [];

            // 1. 순수 압축점 (Pure Compression)
            const Po = 0.85 * fck * (b * h - As - As_prime) + (As + As_prime) * fy;
            points.push({ c: Infinity, Pn: Po, Mn: 0 });

            // 2. 중립축(c) 변화에 따른 점들 계산
            // 중립축 깊이 c를 여러 구간으로 나누어 계산
            const c_steps = [
                ...Array.from({length: 100}, (_, i) => h * 5 - i * (h*5-d)/100), // 압축 지배
                ...Array.from({length: 200}, (_, i) => d - i * (d - d_prime)/200), // 전이 구간
                ...Array.from({length: 100}, (_, i) => d_prime - i * d_prime/100) // 인장 지배
            ];
            
            for (const c of c_steps) {
                if (c <= 0.001) continue;

                const a = beta1 * c;
                
                // 변형률 계산 (Strain Compatibility)
                const epsilon_s_prime = epsilon_cu * (c - d_prime) / c;
                const epsilon_s = epsilon_cu * (d - c) / c;

                // 철근 응력 계산
                let fs_prime = Es * epsilon_s_prime;
                fs_prime = Math.max(-fy, Math.min(fy, fs_prime));

                let fs = Es * epsilon_s;
                fs = Math.max(-fy, Math.min(fy, fs));
                
                // 힘 계산
                const Cc = 0.85 * fck * a * b;
                // 압축철근이 차지하는 콘크리트 면적 보정
                const Cs = As_prime * (fs_prime - (c > d_prime ? 0.85 * fck : 0));
                const Ts = As * fs;

                // 공칭 축력 및 모멘트 계산
                const Pn = Cc + Cs - Ts;
                // 단면의 중심에 대한 모멘트
                const Mn = Cc * (h / 2 - a / 2) + Cs * (h / 2 - d_prime) + Ts * (d - h / 2);
                
                if (Pn >= 0 && Mn >= 0) {
                    points.push({ c, Pn, Mn, epsilon_s });
                }
            }

            // 3. 순수 인장점 (Pure Tension)
            const Pt = -(As + As_prime) * fy;
            points.push({ c: 0, Pn: Pt, Mn: 0 });

            // 강도감소계수(phi) 적용
            const designPoints = points.map(p => {
                let phi;
                const epsilon_t = p.epsilon_s;
                
                if (p.Pn < 0) { // 순수 인장
                    phi = 0.85;
                } else if (epsilon_t === undefined || epsilon_t <= epsilon_y) { // 압축 지배
                    phi = 0.65; // 띠철근 기둥 가정
                } else if (epsilon_t >= 0.005) { // 인장 지배
                    phi = 0.85;
                } else { // 전이 구간
                    phi = 0.65 + 0.20 * (epsilon_t - epsilon_y) / (0.005 - epsilon_y);
                }
                
                return {
                    Pn: phi * p.Pn,
                    Mn: phi * p.Mn
                };
            });

            // 단위를 kN, kN.m로 변환
            const nominalPoints = points.map(p => ({ m: p.Mn / 1e6, p: p.Pn / 1e3 }));
            const phiPoints = designPoints.map(p => ({ m: p.Mn / 1e6, p: p.Pn / 1e3 }));
            
            // 축력이 0 이하인 부분은 제외 (일반적인 PM선도 표현)
            return {
                nominal: nominalPoints.filter(pt => pt.p >= 0),
                design: phiPoints.filter(pt => pt.p >= 0)
            };
        }

        // --- PM 상관도 그래프 그리기 ---
        function drawPMDiagram(data) {
            const { nominal, design } = data;
            const canvas = pmCanvas;
            const ctx = pmCtx;
            
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 최대값 찾기 (스케일링을 위해)
            const maxM = Math.max(...nominal.map(p => p.m), 0);
            const maxP = Math.max(...nominal.map(p => p.p), 0);
            
            if (maxM === 0 || maxP === 0) return;

            // 여백 및 스케일 설정
            const margin = { top: 40, right: 40, bottom: 60, left: 80 };
            const chartWidth = canvas.width - margin.left - margin.right;
            const chartHeight = canvas.height - margin.top - margin.bottom;

            const xScale = chartWidth / (maxM * 1.1);
            const yScale = chartHeight / (maxP * 1.1);

            // 좌표 변환 함수
            const transform = (m, p) => ({
                x: margin.left + m * xScale,
                y: canvas.height - margin.bottom - p * yScale
            });

            // 축 및 그리드 그리기
            ctx.strokeStyle = '#4a5568'; // gray-600
            ctx.fillStyle = '#a0aec0'; // gray-400
            ctx.lineWidth = 1;
            ctx.font = '12px Noto Sans KR';

            // Y축 (축하중)
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= 10; i++) {
                const pValue = (maxP * 1.1 / 10) * i;
                const yPos = transform(0, pValue).y;
                ctx.fillText(pValue.toFixed(0), margin.left - 10, yPos);
                ctx.beginPath();
                ctx.moveTo(margin.left, yPos);
                ctx.lineTo(margin.left + chartWidth, yPos);
                ctx.stroke();
            }
            ctx.save();
            ctx.translate(margin.left - 60, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = '14px Noto Sans KR';
            ctx.fillText('축하중 (P, kN)', 0, 0);
            ctx.restore();

            // X축 (모멘트)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = 0; i <= 10; i++) {
                const mValue = (maxM * 1.1 / 10) * i;
                const xPos = transform(mValue, 0).x;
                ctx.fillText(mValue.toFixed(0), xPos, canvas.height - margin.bottom + 10);
                ctx.beginPath();
                ctx.moveTo(xPos, margin.top);
                ctx.lineTo(xPos, canvas.height - margin.bottom);
                ctx.stroke();
            }
            ctx.fillText('모멘트 (M, kN·m)', canvas.width / 2, canvas.height - margin.bottom + 40);

            // 곡선 그리기 함수
            const drawCurve = (points, color) => {
                if (points.length < 2) return;
                ctx.beginPath();
                const startPoint = transform(points[0].m, points[0].p);
                ctx.moveTo(startPoint.x, startPoint.y);
                points.forEach(point => {
                    const p = transform(point.m, point.p);
                    ctx.lineTo(p.x, p.y);
                });
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.stroke();
            };

            // 공칭 강도 곡선
            drawCurve(nominal, '#22d3ee'); // cyan-400
            // 설계 강도 곡선
            drawCurve(design, '#ef4444'); // red-500
        }

        // --- 이벤트 리스너 설정 ---
        function init() {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                drawBtn.disabled = true;
                drawBtn.textContent = '계산 중...';
                
                // 비동기 처리를 위해 setTimeout 사용 (UI 렌더링 보장)
                setTimeout(() => {
                    const points = calculatePMPoints();
                    if (points) {
                        drawPMDiagram(points);
                    }
                    drawBtn.disabled = false;
                    drawBtn.textContent = 'PM 상관도 그리기';
                }, 50);
            });
            
            // 입력값 변경 시 단면 실시간 업데이트
            const inputsForSection = ['b', 'h', 'd_prime', 'as_prime_num', 'as_prime_dia', 'as_num', 'as_dia'];
            inputsForSection.forEach(id => {
                document.getElementById(id).addEventListener('input', drawSection);
            });

            // 창 크기 변경 시 다시 그리기
            window.addEventListener('resize', () => {
                drawSection();
                const points = calculatePMPoints();
                if (points) {
                    drawPMDiagram(points);
                }
            });

            // 초기 로드 시 그리기
            drawSection();
            drawBtn.click();
        }

        // 애플리케이션 초기화
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
